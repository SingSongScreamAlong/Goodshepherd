services:
  redis:
    image: redis:7.4-alpine
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  postgres:
    image: postgis/postgis:17-3.5
    restart: unless-stopped
    environment:
      POSTGRES_DB: goodshepherd
      POSTGRES_USER: goodshepherd
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-goodshepherd}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U goodshepherd"]
      interval: 10s
      timeout: 5s
      retries: 5

  meilisearch:
    image: getmeili/meilisearch:v1.11.3
    restart: unless-stopped
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY:-local_dev_key}
    ports:
      - "7700:7700"
    volumes:
      - meili_data:/meili_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

  backend-worker:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    restart: unless-stopped
    command: ["python", "-m", "backend.ingestion.ingest_service"]
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - redis

  backend-processor:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    restart: unless-stopped
    command: ["python", "-m", "backend.processing.event_processor"]
    environment:
      REDIS_URL: redis://redis:6379/0
      DATABASE_URL: postgresql+psycopg://goodshepherd:goodshepherd@postgres:5432/goodshepherd
    depends_on:
      - redis
      - postgres
      - meilisearch

  backend-api:
    build:
      context: ..
      dockerfile: docker/backend.Dockerfile
    restart: unless-stopped
    command: ["uvicorn", "backend.processing.api_main:app", "--host", "0.0.0.0", "--port", "8000"]
    environment:
      REDIS_URL: redis://redis:6379/0
      DATABASE_URL: postgresql+asyncpg://goodshepherd:${POSTGRES_PASSWORD:-goodshepherd}@postgres:5432/goodshepherd
      MEILI_HTTP_ADDR: http://meilisearch:7700
      # Admin API Key
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # JWT Authentication
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000}
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      # Account Security
      MAX_FAILED_LOGIN_ATTEMPTS: ${MAX_FAILED_LOGIN_ATTEMPTS:-5}
      LOCKOUT_DURATION_MINUTES: ${LOCKOUT_DURATION_MINUTES:-15}
      MAX_SESSIONS_PER_USER: ${MAX_SESSIONS_PER_USER:-5}
      # Twilio SMS/WhatsApp
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      TWILIO_WHATSAPP_NUMBER: ${TWILIO_WHATSAPP_NUMBER:-}
      # SMTP Email
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Good Shepherd}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      # Intelligence Sources
      ACLED_API_KEY: ${ACLED_API_KEY:-}
      ACLED_EMAIL: ${ACLED_EMAIL:-}
    depends_on:
      - redis
      - postgres
      - meilisearch
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      REACT_APP_API_BASE: http://backend-api:8000
      REACT_APP_WS_URL: ws://backend-api:8000/ws
    depends_on:
      - backend-api
    ports:
      - "3000:3000"

  caddy:
    image: caddy:2.8-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      ACME_AGREE: "true"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - backend-api
      - frontend

volumes:
  pg_data:
  meili_data:
  minio_data:
  caddy_data:
  caddy_config:
